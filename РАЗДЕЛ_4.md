# 4. ОПИСАНИЕ ПРОГРАММЫ

## 4.1 Общие сведения о программе

Программа «Менеджер паролей» предназначена для безопасного хранения, генерации и управления паролями пользователей. Она обеспечивает end-to-end шифрование данных, разграничение доступа через систему аутентификации, а также предоставляет графический интерфейс для взаимодействия с системой.

**Бэкенд** реализован на C++ с использованием стандартной библиотеки и следующих компонентов:
1. **libsodium** — криптографическая библиотека для шифрования данных (Argon2id, AES-256-GCM, PBKDF2, SHA-512);
2. **nlohmann/json** — библиотека для работы с JSON-форматом данных;
3. **POSIX sockets** — для реализации TCP-сервера клиент-серверного взаимодействия;
4. **Qt Framework** (клиент) — для создания кроссплатформенного графического интерфейса.

**Фронтенд** реализован на базе Qt Framework (C++) с использованием QWidget для создания графического интерфейса пользователя.

**Уровень данных** базируется на файловой системе с использованием специализированных структур данных:
1. **Пользователи** (файл users.json) — хранение учётных данных с хешированием паролей Argon2id;
2. **Хранилища паролей** (файлы *.vault) — зашифрованные хранилища записей паролей пользователей;
3. **Хеш-таблицы** — эффективные структуры данных с открытой адресацией для быстрого поиска.

**Клиентское приложение** — Qt-приложение с графическим интерфейсом, обеспечивающее локальное управление паролями и синхронизацию с сервером.

**Основные модули программы:**

**Серверная часть:**
1. **Server** — TCP-сервер для обработки запросов клиентов;
2. **HashTableUsers** — модуль управления пользователями с хеш-таблицей;
3. **UserHashTable** — модуль управления хранилищами паролей с шифрованием;
4. **AuthManager** (register, log_in) — система аутентификации и регистрации пользователей;
5. **common_utils** — утилиты криптографии и валидации данных.

**Клиентская часть:**
1. **Client** — модуль сетевого взаимодействия с сервером;
2. **MainWindow** — графический интерфейс пользователя на Qt;
3. **UserHashTable** — локальное хранилище паролей с шифрованием;
4. **common_utils** — криптографические операции на стороне клиента;
5. **PasswordGenerator** — генератор криптостойких паролей;
6. **PasswordEvaluator** — оценка сложности паролей.

## 4.6 Сообщения системному программисту

Данный раздел содержит описание технических сообщений, которые система выводит в консоль или лог-файлы для информирования системного программиста о состоянии компонентов и выявления проблем на этапе разработки, отладки и эксплуатации.

### 4.6.1 Сообщения серверной части

| Сообщение | Тип | Назначение | Возможные причины | Действие программиста |
|-----------|-----|------------|-------------------|----------------------|
| "Запуск сервера на порту [порт]..." | Информационное | Информирует о начале процесса запуска сервера | — | Ожидать последующих сообщений о результате инициализации |
| "Сервер инициализирован на порту [порт]" | Информационное | Подтверждение успешной инициализации сервера | — | Нормальная работа, сервер готов принимать соединения |
| "Сервер запущен и ожидает подключений..." | Информационное | Сервер перешёл в режим прослушивания входящих соединений | — | Сервер в рабочем состоянии, ожидает клиентов |
| "Ошибка: не удалось создать сокет" | Ошибка | Критическая ошибка создания TCP-сокета | Недостаточно прав доступа, исчерпаны системные ресурсы | Проверить права пользователя, запустить с sudo, проверить лимиты системы |
| "Ошибка: не удалось установить опции сокета" | Ошибка | Не удалось настроить параметры сокета (SO_REUSEADDR) | Некорректные параметры, ограничения ОС | Проверить версию ядра ОС, права доступа |
| "Ошибка: не удалось привязать сокет к порту [порт]" | Ошибка | Не удалось привязать сокет к указанному порту | Порт занят другим приложением, недостаточно прав | Проверить занятость порта: `netstat -tuln \| grep [порт]`, остановить конфликтующий процесс или использовать другой порт |
| "Возможно, порт уже используется другим процессом" | Подсказка | Дополнительная информация к предыдущей ошибке | — | Для портов < 1024 требуются права root |
| "Ошибка: не удалось начать прослушивание сокета" | Ошибка | Не удалось перевести сокет в режим listen | Системная ошибка, повреждение сокета | Перезапустить приложение, проверить системные логи |
| "Не удалось инициализировать сервер" | Ошибка | Общая ошибка инициализации, сервер не запущен | См. предыдущие сообщения об ошибках | Проанализировать предыдущие сообщения об ошибках, код возврата 1 |
| "Получен сигнал прерывания ([номер]). Остановка сервера..." | Информационное | Сервер получил сигнал завершения (SIGINT, SIGTERM) | — | Нормальное завершение, ресурсы освобождаются (graceful shutdown) |
| "Файл повреждён — начинаем с нуля" | Предупреждение | Обнаружено повреждение файла users.json или хранилища | Ошибка парсинга JSON, повреждение файловой системы | Восстановить из резервной копии, если копии нет — данные утеряны |
| "Не удалось открыть файл для записи: [filename]" | Ошибка | Ошибка при сохранении данных в файл | Нет прав на запись, нет места на диске, файл заблокирован | Проверить права: `ls -la [filename]`, свободное место: `df -h`, блокировки: `lsof [filename]` |
| "Слова юзера: [words]" | Debug | Отладочная информация при проверке seed-фразы | — | Для отладки процесса верификации seed-фразы, в продакшне отключить |
| "Хэш в таблице: [hash]" | Debug | Отладочная информация — сохранённый хеш seed-фразы | — | Для отладки процесса верификации seed-фразы, в продакшне отключить |
| "Полученный хэш: [hash]" | Debug | Отладочная информация — вычисленный хеш seed-фразы | — | Для отладки процесса верификации seed-фразы, в продакшне отключить |

### 4.6.2 Исключения и runtime errors

| Исключение | Модуль | Назначение | Возможные причины | Действие программиста |
|------------|--------|------------|-------------------|----------------------|
| "Libsodium initialization failed" | common_utils | Не удалось инициализировать библиотеку libsodium | Библиотека не установлена или повреждена | Установить/переустановить: `sudo apt-get install libsodium-dev` |
| "Argon2 hashing failed - out of memory" | common_utils | Недостаточно памяти для выполнения хеширования Argon2 | Слишком высокие параметры memlimit, недостаточно RAM | Увеличить доступную память или уменьшить параметры Argon2 |
| "Cannot open /dev/urandom" | common_utils | Не удалось открыть генератор случайных чисел | Ограничения безопасности, повреждение системы | Проверить доступность /dev/urandom, права доступа |
| "Failed to read enough random bytes" | common_utils | Ошибка чтения случайных данных | Прерывание чтения, системная ошибка | Повторить операцию, проверить системные логи |
| "Invalid key size for AES-256-GCM" | userHashTable | Передан ключ неправильного размера (ожидается 32 байта) | Программная ошибка при деривации ключа | Проверить функцию deriveVaultKey, корректность PBKDF2 |
| "Encryption failed" | userHashTable | Ошибка при шифровании данных AES-256-GCM | Неверный ключ, ошибка библиотеки | Проверить целостность ключа, проверить логи libsodium |
| "Decryption failed" | userHashTable | Ошибка при дешифровании данных AES-256-GCM | Неверный ключ, повреждённые данные | Проверить ключ и данные, повторить синхронизацию |
| "Blob too small to contain nonce" | userHashTable | Зашифрованный блок меньше минимального размера | Повреждение данных, неполная передача по сети | Проверить целостность данных, повторить синхронизацию |
| "Хранилище пользователя не найдено" | server | Файл [username].vault не существует | Удалён вручную, не создан при регистрации | Восстановить из backup или пользователь должен пересоздать аккаунт |
| "Ошибка чтения хранилища пользователя" | server | Не удалось прочитать файл хранилища | Повреждение файла, проблемы с правами | Проверить целостность файла, восстановить из backup |
| "Failed to open english.txt dictionary file" | register, log_in | Не найден файл словаря для генерации seed-фразы | Файл отсутствует в рабочей директории | Убедиться что english.txt находится в директории приложения |
| "Dictionary file must contain at least 2048 words" | register, log_in | Словарь содержит недостаточно слов | Повреждение или неполный файл словаря | Заменить english.txt на корректную версию |
| "Invalid word index: [index]" | register, log_in | Попытка обращения к несуществующему индексу в словаре | Программная ошибка в генерации случайных чисел | Проверить логику генерации индексов, RNG |
| "Hex string must have even length" | common_utils | Строка в hex-формате имеет нечётное количество символов | Повреждение данных при передаче | Проверить формирование hex-строк, кодирование |
| "Not enough bits in vector" | common_utils | Вектор байтов слишком мал | Программная ошибка при работе с битами | Проверить размер входных данных |
| "Unexpected end of data" | common_utils | Преждевременное окончание данных при парсинге | Неполная передача, повреждение данных | Проверить целостность передачи данных по сети |

### 4.6.3 Сообщения клиентской части

| Сообщение | Тип | Назначение | Возможные причины | Действие программиста |
|-----------|-----|------------|-------------------|----------------------|
| "Ошибка создания сокета" | Ошибка | Не удалось создать клиентский TCP-сокет | Системные ограничения, нехватка ресурсов | Проверить системные лимиты, перезапустить приложение |
| "Неверный адрес сервера" | Ошибка | Некорректный формат IP-адреса или имени хоста | Опечатка в адресе, недоступный DNS | Проверить правильность адреса сервера в настройках |
| "Не удалось подключиться к серверу" | Ошибка | Не установлено TCP-соединение с сервером | Сервер недоступен, неверный порт, firewall | Проверить работу сервера, доступность порта: `telnet [host] [port]`, настройки firewall |
| "Не получен ответ от сервера" | Ошибка | Таймаут ожидания ответа от сервера | Сервер завис, проблемы сети, большая нагрузка | Проверить состояние сервера, сетевое подключение |
| "=== Менеджер паролей ===" | Информационное | Заголовок консольного интерфейса CLI | — | Нормальная работа CLI-интерфейса |
| "⚠️ ОШИБКА: [сообщение]" | Ошибка | Отображение ошибок валидации в консоли | Некорректный ввод пользователя | Проверить корректность вводимых данных |

**"Invalid key size for AES-256-GCM"**
- **Назначение:** Передан ключ неправильного размера для AES-256-GCM (ожидается 32 байта)
- **Возможные причины:** Программная ошибка при деривации ключа
- **Действие:** Проверить функцию deriveVaultKey, убедиться в корректности PBKDF2

**"Encryption failed" / "Decryption failed"**
- **Назначение:** Ошибка при шифровании или дешифровании данных
- **Возможные причины:** Неверный ключ, повреждённые данные, ошибка библиотеки
- **Действие:** Проверить целостность ключа и данных, проверить логи libsodium

**"Blob too small to contain nonce"**
- **Назначение:** Зашифрованный блок данных меньше минимального размера
- **Возможные причины:** Повреждение данных, неполная передача по сети
- **Действие:** Проверить целостность данных, повторить синхронизацию

#### Ошибки работы с данными

**"Хранилище пользователя не найдено"**
- **Назначение:** Файл [username].vault не существует в server_vaults/
- **Возможные причины:** Удалён вручную, не создан при регистрации
- **Действие:** Восстановить из backup или пользователь должен пересоздать аккаунт

**"Ошибка чтения хранилища пользователя"**
- **Назначение:** Не удалось прочитать файл хранилища
- **Возможные причины:** Повреждение файла, проблемы с правами доступа
- **Действие:** Проверить целостность файла, восстановить из backup

**"Failed to open english.txt dictionary file"**
- **Назначение:** Не найден файл словаря для генерации seed-фразы
- **Возможные причины:** Файл отсутствует в рабочей директории
- **Действие:** Убедиться что english.txt находится в директории приложения

**"Dictionary file must contain at least 2048 words"**
- **Назначение:** Словарь содержит недостаточно слов для генерации seed-фразы
- **Возможные причины:** Повреждение или неполный файл словаря
- **Действие:** Заменить english.txt на корректную версию

**"Invalid word index: [index]"**

### 4.6.4 Рекомендации по отладке

Для эффективной отладки приложения рекомендуется:

1. **Включение детального логирования:**
   - Использовать `#define DEBUG_MODE` для условной компиляции отладочных сообщений
   - Перенаправлять stderr в файл: `./server 2> server_errors.log`
   - Использовать системный журнал syslog для продакшн-среды

2. **Проверка состояния компонентов:**
   - Проверить процесс: `ps aux | grep server`
   - Проверить порт: `netstat -tuln | grep 8080`
   - Проверить файлы данных: `ls -la users.json server_vaults/`
   - Валидировать JSON: `cat users.json | jq .`

3. **Типичные сценарии отладки:**
   - **Сервер не запускается:** проверить вывод stderr, занятость порта, права доступа, наличие библиотек (`ldd ./server`)
   - **Клиент не подключается:** убедиться что сервер запущен, проверить доступность порта (`telnet localhost 8080`), проверить firewall
   - **Ошибки криптографии:** проверить установку libsodium (`ldconfig -p | grep sodium`), увеличить память при ошибках Argon2

## 4.7 Взаимосвязь модулей системы

Система менеджера паролей построена по модульной архитектуре с чётким разделением компонентов. Ниже представлено описание основных модулей и их взаимодействия.

### 4.7.1 Структура модулей

#### Серверная часть (Server)

**Главный модуль: server.cpp / server.h**
- Координирует работу всех серверных компонентов
- Управляет TCP-соединениями и обработкой запросов
- Зависимости: hashTableUrers, userHashTable, common_utils, register, log_in, json.hpp

**Модуль хеш-таблицы пользователей: hashTableUrers.cpp / hashTableUrers.h**
- Хранит данные аутентификации пользователей
- Реализует хеш-таблицу с открытой адресацией
- Методы: insert, deleteKey, searchLogin, getHashPassword, getSeedPhraseHash
- Сохранение/загрузка: users.json
- Зависимости: common_utils, json.hpp

**Модуль хранилищ паролей: userHashTable.cpp / userHashTable.h**
- Хранит записи паролей пользователя (service, login, password, url, note)
- Реализует хеш-таблицу для эффективного поиска
- Криптография: encrypt_aes_gcm, decrypt_aes_gcm (AES-256-GCM)
- Сохранение: бинарные файлы в server_vaults/[username].vault
- Зависимости: common_utils, json.hpp, libsodium

**Модуль регистрации: register.cpp / register.h**
- Генерация seed-фразы восстановления (12 слов)
- Использует english.txt (словарь BIP39)
- Зависимости: hashTableUrers, common_utils

**Модуль входа: log_in.cpp / log_in.h**
- Проверка существования пользователя
- Верификация пароля
- Проверка seed-фразы при восстановлении
- Зависимости: hashTableUrers, common_utils

**Утилиты: common_utils.cpp / common_utils.h**
- Криптографические функции (Argon2, SHA-512, генерация солей)
- Валидация (validateUsername, validatePassword)
- Конвертация данных (toHex, hexToBytes)
- Генерация seed-фраз
- Зависимости: libsodium

**Точка входа: server_main.cpp**
- Инициализация и запуск сервера
- Обработка сигналов (SIGINT, SIGTERM)
- Зависимости: server

#### Клиентская часть (Client)

**Главный модуль клиента: client.cpp / client.h**
- Сетевое взаимодействие с сервером (TCP)
- Криптография на стороне клиента (деривация ключей, шифрование хранилища)
- Управление сессией пользователя
- Синхронизация данных с сервером
- Зависимости: userHashTable, common_utils, json.hpp

**Модуль GUI: mainwindow.cpp / mainwindow.h**
- Графический интерфейс на Qt
- Отображение форм (регистрация, вход, управление паролями)
- Обработка пользовательского ввода
- Взаимодействие с client для выполнения операций
- Зависимости: client, common_utils, Qt Framework

**Точка входа GUI: gui_main.cpp**
- Создание QApplication
- Инициализация главного окна
- Зависимости: mainwindow, Qt

**Точка входа CLI: client_main.cpp**
- Консольный интерфейс менеджера паролей
- Меню и обработка команд
- Зависимости: client, common_utils

**Общие модули клиента:**
- hashTableUrers.cpp/h — аналогичен серверной версии
- userHashTable.cpp/h — аналогичен серверной версии
- common_utils.cpp/h — аналогичен серверной версии
- register.cpp/h — генерация seed-фраз
- log_in.cpp/h — вспомогательные функции

### 4.7.2 Схема взаимодействия модулей

```
┌─────────────────── КЛИЕНТ ───────────────────┐
│                                               │
│  ┌──────────────┐      ┌──────────────────┐  │
│  │ MainWindow   │◄────►│   Client         │  │
│  │ (Qt GUI)     │      │  (Сетевой слой)  │  │
│  └──────────────┘      └─────────┬────────┘  │
│         │                        │           │
│         │                        │           │
│         ▼                        ▼           │
│  ┌─────────────────────────────────────┐    │
│  │      UserHashTable                  │    │
│  │  (Локальное хранилище паролей)     │    │
│  └─────────────────────────────────────┘    │
│                   │                          │
│                   ▼                          │
│  ┌─────────────────────────────────────┐    │
│  │      common_utils                   │◄───┼─── libsodium
│  │  (Криптография, валидация)          │    │
│  └─────────────────────────────────────┘    │
│                                               │
└───────────────┬───────────────────────────────┘
                │ TCP/IP (JSON)
                │ port 8080
                ▼
┌─────────────────── СЕРВЕР ───────────────────┐
│                                               │
│  ┌──────────────────────────────────────┐    │
│  │         Server                       │    │
│  │    (Обработка TCP-запросов)          │    │
│  └──────┬────────────────────┬──────────┘    │
│         │                    │                │
│         ▼                    ▼                │
│  ┌─────────────┐      ┌─────────────────┐    │
│  │HashTableUsers│      │ UserHashTable   │    │
│  │(Пользователи)│      │(Хранилища)      │    │
│  └──────┬──────┘      └────────┬────────┘    │
│         │                      │              │
│         │ users.json           │ *.vault      │
│         ▼                      ▼              │
│  ┌─────────────────────────────────────┐     │
│  │   Файловая система                  │     │
│  │   - users.json                      │     │
│  │   - server_vaults/[user].vault      │     │
│  └─────────────────────────────────────┘     │
│         ▲                                     │
│         │                                     │
│  ┌──────┴──────────────────────────────┐     │
│  │      common_utils                   │◄────┼─── libsodium
│  │  (Криптография, валидация)          │     │
│  └─────────────────────────────────────┘     │
│         ▲                                     │
│         │                                     │
│  ┌──────┴──────┐    ┌────────────┐           │
│  │  register   │    │  log_in    │           │
│  │(Регистрация)│    │  (Вход)    │           │
│  └─────────────┘    └────────────┘           │
│                                               │
└───────────────────────────────────────────────┘
```

### 4.7.3 Потоки данных между модулями

#### Регистрация пользователя

1. **MainWindow/CLI** → получает данные от пользователя (username, password, codeWord)
2. **MainWindow** → вызывает `client.registerUser(username, password, codeWord, seedWords)`
3. **Client** → формирует JSON-запрос `{"type": "register", "username": "...", "password": "..."}`
4. **Client** → отправляет через TCP на сервер
5. **Server** → принимает запрос в `handleClient()`, маршрутизирует в `handleRegister()`
6. **Server** → вызывает `validateUsername()` и `validatePassword()` из common_utils
7. **Server** → проверяет уникальность через `HashTableUsers.searchLogin()`
8. **Server** → генерирует соль через `generateSaltRaw()`, хеширует пароль через `hashPasswordArgon2id()`
9. **Server** → вызывает `loginExist()` из register для генерации seed-фразы
10. **Server** → сохраняет пользователя в `HashTableUsers.insert()`
11. **Server** → сохраняет в `users.json` через `HashTableUsers.saveToFile()`
12. **Server** → создаёт пустое зашифрованное хранилище через `createUserVault()`
13. **Server** → отправляет JSON-ответ с seed-фразой клиенту
14. **Client** → получает ответ, возвращает seed-фразу
15. **MainWindow** → отображает seed-фразу пользователю

#### Вход в систему

1. **MainWindow** → получает (username, password, codeWord)
2. **Client** → `login(username, password, codeWord)`
3. **Client** → отправляет запрос `{"type": "login", ...}` на сервер
4. **Server** → `handleLogin()` проверяет пользователя в HashTableUsers
5. **Server** → сравнивает хеш пароля (Argon2)
6. **Server** → читает зашифрованное хранилище из `server_vaults/[username].vault`
7. **Server** → отправляет vaultSalt и encrypted_vault клиенту
8. **Client** → деривирует ключ: `deriveVaultKey(codeWord, vaultSalt)` через PBKDF2
9. **Client** → дешифрует хранилище: `decryptAndLoadVault()` через AES-256-GCM
10. **Client** → загружает записи в локальный `UserHashTable`
11. **Client** → устанавливает `isLoggedIn = true`
12. **MainWindow** → переходит в режим работы с паролями

#### Добавление/изменение записи пароля

1. **MainWindow** → пользователь вводит (service, login, password, url, note)
2. **MainWindow** → вызывает `client.addEntry(...)`
3. **Client** → добавляет в локальный `vault->insert(...)`
4. **Client** → вызывает `syncToServer()` для синхронизации
5. **Client** → сериализует хранилище: `vault->toJson()`
6. **Client** → шифрует JSON: `encryptVault()` через AES-256-GCM
7. **Client** → отправляет запрос `{"type": "update_vault", "encrypted_vault": "..."}`
8. **Server** → `handleUpdateVault()` получает зашифрованные данные
9. **Server** → сохраняет в файл: `updateUserVault(username, encryptedData)`
10. **Server** → отправляет подтверждение клиенту
11. **MainWindow** → обновляет отображение списка паролей

### 4.7.4 Зависимости между модулями

**Иерархия зависимостей (от низкого к высокому уровню):**

1. **Уровень 0: Внешние библиотеки**
   - libsodium (криптография)
   - json.hpp (nlohmann/json для JSON)
   - Qt Framework (только для GUI-клиента)

2. **Уровень 1: Базовые утилиты**
   - common_utils (использует libsodium)

3. **Уровень 2: Структуры данных**
   - HashTableUsers (использует common_utils, json)
   - UserHashTable (использует common_utils, json, libsodium)

4. **Уровень 3: Бизнес-логика**
   - register (использует HashTableUsers, common_utils)
   - log_in (использует HashTableUsers, common_utils)

5. **Уровень 4: Основные компоненты**
   - Server (использует все модули уровней 1-3, сетевой слой)
   - Client (использует UserHashTable, common_utils, сетевой слой)

6. **Уровень 5: Интерфейсы пользователя**
   - MainWindow (использует Client, Qt)
   - CLI клиент (использует Client)
   - server_main (использует Server)

### 4.7.5 Механизмы взаимодействия

**Протокол клиент-сервер:**
- Транспорт: TCP sockets
- Формат данных: JSON
- Кодировка: UTF-8
- Структура запроса: `{"type": "operation", "param1": "value1", ...}`
- Структура ответа: `{"status": "success|error", "message": "...", "data": {...}}`

**Синхронизация данных:**
- Клиент хранит локальную копию хранилища паролей
- При изменении автоматически синхронизируется с сервером
- Сервер хранит зашифрованные данные (не может их прочитать без кодового слова)

**Криптографическая безопасность:**
- Пароли пользователей хешируются на сервере (Argon2id)
- Хранилища паролей шифруются на клиенте (AES-256-GCM)
- Ключ шифрования деривируется из кодового слова (PBKDF2)
- Сервер никогда не получает кодовое слово (end-to-end encryption)
