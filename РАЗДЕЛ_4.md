# 4. ОПИСАНИЕ ПРОГРАММЫ

## 4.6 Сообщения системному программисту

Данный раздел содержит описание технических сообщений, которые система выводит в консоль или лог-файлы для информирования системного программиста о состоянии компонентов и выявления проблем на этапе разработки, отладки и эксплуатации.

### 4.6.1 Сообщения серверной части

#### Сообщения инициализации и запуска

**"Запуск сервера на порту [порт]..."**
- **Назначение:** Информирует о начале процесса запуска сервера
- **Контекст:** Выводится при старте серверного приложения в server_main.cpp
- **Действие:** Ожидать последующих сообщений о результате инициализации

**"Сервер инициализирован на порту [порт]"**
- **Назначение:** Подтверждение успешной инициализации сервера
- **Контекст:** Сокет создан, настроен и привязан к порту
- **Действие:** Нормальная работа, сервер готов принимать соединения

**"Сервер запущен и ожидает подключений..."**
- **Назначение:** Сервер перешёл в режим прослушивания входящих соединений
- **Контекст:** Основной цикл обработки клиентов запущен
- **Действие:** Сервер в рабочем состоянии, ожидает клиентов

#### Сообщения об ошибках инициализации

**"Ошибка: не удалось создать сокет"**
- **Назначение:** Критическая ошибка создания TCP-сокета
- **Возможные причины:** Недостаточно прав доступа, исчерпаны системные ресурсы
- **Действие:** Проверить права пользователя, запустить с sudo (при необходимости), проверить лимиты системы

**"Ошибка: не удалось установить опции сокета"**
- **Назначение:** Не удалось настроить параметры сокета (например, SO_REUSEADDR)
- **Возможные причины:** Некорректные параметры, ограничения ОС
- **Действие:** Проверить версию ядра ОС, права доступа

**"Ошибка: не удалось привязать сокет к порту [порт]"**
**"Возможно, порт уже используется другим процессом"**
- **Назначение:** Не удалось привязать сокет к указанному порту
- **Возможные причины:** Порт занят другим приложением, недостаточно прав
- **Действие:** 
  - Проверить занятость порта: `netstat -tuln | grep [порт]` или `lsof -i :[порт]`
  - Остановить конфликтующий процесс или использовать другой порт
  - Для портов < 1024 требуются права root

**"Ошибка: не удалось начать прослушивание сокета"**
- **Назначение:** Не удалось перевести сокет в режим listen
- **Возможные причины:** Системная ошибка, повреждение сокета
- **Действие:** Перезапустить приложение, проверить системные логи

**"Не удалось инициализировать сервер"**
- **Назначение:** Общая ошибка инициализации, сервер не запущен
- **Контекст:** Возвращается код ошибки 1
- **Действие:** Проанализировать предыдущие сообщения об ошибках

#### Сообщения завершения работы

**"Получен сигнал прерывания ([номер]). Остановка сервера..."**
- **Назначение:** Сервер получил сигнал завершения (SIGINT, SIGTERM)
- **Контекст:** Graceful shutdown, вызван обработчик signalHandler
- **Действие:** Нормальное завершение, ресурсы освобождаются

#### Сообщения о работе с хранилищами

**"Файл повреждён — начинаем с нуля"**
- **Назначение:** Обнаружено повреждение файла users.json или файла хранилища
- **Контекст:** Ошибка парсинга JSON при загрузке из файла
- **Действие:** 
  - Восстановить файл из резервной копии
  - Если копии нет — данные утеряны, создаётся новая структура
  - Проанализировать причину повреждения

**"Не удалось открыть файл для записи: [filename]"**
- **Назначение:** Ошибка при сохранении данных в файл
- **Возможные причины:** Нет прав на запись, нет места на диске, файл заблокирован
- **Действие:**
  - Проверить права доступа: `ls -la [filename]`
  - Проверить свободное место: `df -h`
  - Проверить блокировки: `lsof [filename]`

#### Отладочные сообщения (Debug)

**"Слова юзера: [words]"**
**"Хэш в таблице: [hash]"**
**"Полученный хэш: [hash]"**
- **Назначение:** Отладочная информация при проверке seed-фразы восстановления
- **Контекст:** Функция checkPhrase в log_in.cpp
- **Действие:** Для отладки процесса верификации seed-фразы, в продакшне следует отключить

### 4.6.2 Исключения и runtime errors (throw)

#### Криптографические ошибки

**"Libsodium initialization failed"**
- **Назначение:** Не удалось инициализировать библиотеку libsodium
- **Возможные причины:** Библиотека не установлена или повреждена
- **Действие:** Установить/переустановить libsodium: `sudo apt-get install libsodium-dev`

**"Argon2 hashing failed - out of memory"**
- **Назначение:** Недостаточно памяти для выполнения хеширования Argon2
- **Возможные причины:** Слишком высокие параметры memlimit, недостаточно RAM
- **Действие:** Увеличить доступную память или уменьшить параметры Argon2

**"Cannot open /dev/urandom"**
- **Назначение:** Не удалось открыть генератор случайных чисел
- **Возможные причины:** Ограничения безопасности, повреждение системы
- **Действие:** Проверить доступность /dev/urandom, права доступа

**"Failed to read enough random bytes"**
- **Назначение:** Ошибка чтения случайных данных
- **Возможные причины:** Прерывание чтения, системная ошибка
- **Действие:** Повторить операцию, проверить системные логи

**"Invalid key size for AES-256-GCM"**
- **Назначение:** Передан ключ неправильного размера для AES-256-GCM (ожидается 32 байта)
- **Возможные причины:** Программная ошибка при деривации ключа
- **Действие:** Проверить функцию deriveVaultKey, убедиться в корректности PBKDF2

**"Encryption failed" / "Decryption failed"**
- **Назначение:** Ошибка при шифровании или дешифровании данных
- **Возможные причины:** Неверный ключ, повреждённые данные, ошибка библиотеки
- **Действие:** Проверить целостность ключа и данных, проверить логи libsodium

**"Blob too small to contain nonce"**
- **Назначение:** Зашифрованный блок данных меньше минимального размера
- **Возможные причины:** Повреждение данных, неполная передача по сети
- **Действие:** Проверить целостность данных, повторить синхронизацию

#### Ошибки работы с данными

**"Хранилище пользователя не найдено"**
- **Назначение:** Файл [username].vault не существует в server_vaults/
- **Возможные причины:** Удалён вручную, не создан при регистрации
- **Действие:** Восстановить из backup или пользователь должен пересоздать аккаунт

**"Ошибка чтения хранилища пользователя"**
- **Назначение:** Не удалось прочитать файл хранилища
- **Возможные причины:** Повреждение файла, проблемы с правами доступа
- **Действие:** Проверить целостность файла, восстановить из backup

**"Failed to open english.txt dictionary file"**
- **Назначение:** Не найден файл словаря для генерации seed-фразы
- **Возможные причины:** Файл отсутствует в рабочей директории
- **Действие:** Убедиться что english.txt находится в директории приложения

**"Dictionary file must contain at least 2048 words"**
- **Назначение:** Словарь содержит недостаточно слов для генерации seed-фразы
- **Возможные причины:** Повреждение или неполный файл словаря
- **Действие:** Заменить english.txt на корректную версию

**"Invalid word index: [index]"**
- **Назначение:** Попытка обращения к несуществующему индексу в словаре
- **Возможные причины:** Программная ошибка в генерации случайных чисел
- **Действие:** Проверить логику генерации индексов, убедиться в корректности RNG

#### Ошибки валидации данных

**"Hex string must have even length"**
- **Назначение:** Строка в hex-формате имеет нечётное количество символов
- **Возможные причины:** Повреждение данных при передаче, программная ошибка
- **Действие:** Проверить формирование hex-строк, убедиться в корректности кодирования

**"Not enough bits in vector"**
- **Назначение:** Вектор байтов слишком мал для извлечения требуемого количества бит
- **Возможные причины:** Программная ошибка при работе с битовыми операциями
- **Действие:** Проверить размер входных данных

**"Unexpected end of data"**
- **Назначение:** Преждевременное окончание данных при парсинге
- **Возможные причины:** Неполная передача, повреждение данных
- **Действие:** Проверить целостность передачи данных по сети

### 4.6.3 Сообщения клиентской части

#### Ошибки сетевого взаимодействия

**"Ошибка создания сокета"**
- **Назначение:** Не удалось создать клиентский TCP-сокет
- **Возможные причины:** Системные ограничения, нехватка ресурсов
- **Действие:** Проверить системные лимиты, перезапустить приложение

**"Неверный адрес сервера"**
- **Назначение:** Некорректный формат IP-адреса или имени хоста
- **Возможные причины:** Опечатка в адресе, недоступный DNS
- **Действие:** Проверить правильность адреса сервера в настройках

**"Не удалось подключиться к серверу"**
- **Назначение:** Не установлено TCP-соединение с сервером
- **Возможные причины:** Сервер недоступен, неверный порт, блокировка firewall
- **Действие:**
  - Проверить работоспособность сервера
  - Проверить доступность порта: `telnet [host] [port]`
  - Проверить настройки firewall

**"Не получен ответ от сервера"**
- **Назначение:** Таймаут ожидания ответа от сервера
- **Возможные причины:** Сервер завис, проблемы сети, слишком большая нагрузка
- **Действие:** Проверить состояние сервера, сетевое подключение

#### Консольные сообщения (CLI клиент)

**"=== Менеджер паролей ==="**
- **Назначение:** Заголовок консольного интерфейса
- **Контекст:** Главное меню CLI-клиента

**Меню опций:**
- "1. Регистрация"
- "2. Вход"
- "3. Восстановить пароль (забыл пароль)"
- "4. Оценить сложность пароля"

**"⚠️ ОШИБКА: [сообщение]"**
- **Назначение:** Отображение ошибок валидации в консоли
- **Контекст:** Некорректный ввод пользователя при использовании CLI-интерфейса

### 4.6.4 Рекомендации по отладке

#### Включение детального логирования

Для включения подробного логирования в процессе разработки:

1. **Добавить вывод debug-информации:**
   ```cpp
   #define DEBUG_MODE 1
   #ifdef DEBUG_MODE
       std::cout << "[DEBUG] Переменная X = " << x << std::endl;
   #endif
   ```

2. **Перенаправление stderr в файл:**
   ```bash
   ./server 2> server_errors.log
   ```

3. **Использование системного журнала:**
   ```cpp
   #include <syslog.h>
   syslog(LOG_INFO, "Сервер запущен на порту %d", port);
   ```

#### Проверка состояния компонентов

**Проверка сервера:**
```bash
# Проверить процесс
ps aux | grep server

# Проверить порт
netstat -tuln | grep 8080

# Проверить логи
tail -f /var/log/password_manager.log
```

**Проверка файлов данных:**
```bash
# Проверить наличие файлов
ls -la users.json server_vaults/

# Проверить JSON-формат
cat users.json | jq .

# Проверить права доступа
chmod 600 users.json
```

#### Типичные сценарии отладки

**Проблема: Сервер не запускается**
1. Проверить вывод stderr
2. Проверить занятость порта
3. Проверить права доступа к директориям
4. Проверить наличие библиотек: `ldd ./server`

**Проблема: Клиент не подключается**
1. Убедиться что сервер запущен
2. Проверить доступность порта: `telnet localhost 8080`
3. Проверить firewall: `sudo ufw status`
4. Проверить логи сервера

**Проблема: Ошибки криптографии**
1. Проверить установку libsodium: `ldconfig -p | grep sodium`
2. Проверить версию: `pkg-config --modversion libsodium`
3. Увеличить доступную память при ошибках Argon2
4. Проверить целостность данных при ошибках дешифрования

## 4.7 Взаимосвязь модулей системы

Система менеджера паролей построена по модульной архитектуре с чётким разделением компонентов. Ниже представлено описание основных модулей и их взаимодействия.

### 4.7.1 Структура модулей

#### Серверная часть (Server)

**Главный модуль: server.cpp / server.h**
- Координирует работу всех серверных компонентов
- Управляет TCP-соединениями и обработкой запросов
- Зависимости: hashTableUrers, userHashTable, common_utils, register, log_in, json.hpp

**Модуль хеш-таблицы пользователей: hashTableUrers.cpp / hashTableUrers.h**
- Хранит данные аутентификации пользователей
- Реализует хеш-таблицу с открытой адресацией
- Методы: insert, deleteKey, searchLogin, getHashPassword, getSeedPhraseHash
- Сохранение/загрузка: users.json
- Зависимости: common_utils, json.hpp

**Модуль хранилищ паролей: userHashTable.cpp / userHashTable.h**
- Хранит записи паролей пользователя (service, login, password, url, note)
- Реализует хеш-таблицу для эффективного поиска
- Криптография: encrypt_aes_gcm, decrypt_aes_gcm (AES-256-GCM)
- Сохранение: бинарные файлы в server_vaults/[username].vault
- Зависимости: common_utils, json.hpp, libsodium

**Модуль регистрации: register.cpp / register.h**
- Генерация seed-фразы восстановления (12 слов)
- Использует english.txt (словарь BIP39)
- Зависимости: hashTableUrers, common_utils

**Модуль входа: log_in.cpp / log_in.h**
- Проверка существования пользователя
- Верификация пароля
- Проверка seed-фразы при восстановлении
- Зависимости: hashTableUrers, common_utils

**Утилиты: common_utils.cpp / common_utils.h**
- Криптографические функции (Argon2, SHA-512, генерация солей)
- Валидация (validateUsername, validatePassword)
- Конвертация данных (toHex, hexToBytes)
- Генерация seed-фраз
- Зависимости: libsodium

**Точка входа: server_main.cpp**
- Инициализация и запуск сервера
- Обработка сигналов (SIGINT, SIGTERM)
- Зависимости: server

#### Клиентская часть (Client)

**Главный модуль клиента: client.cpp / client.h**
- Сетевое взаимодействие с сервером (TCP)
- Криптография на стороне клиента (деривация ключей, шифрование хранилища)
- Управление сессией пользователя
- Синхронизация данных с сервером
- Зависимости: userHashTable, common_utils, json.hpp

**Модуль GUI: mainwindow.cpp / mainwindow.h**
- Графический интерфейс на Qt
- Отображение форм (регистрация, вход, управление паролями)
- Обработка пользовательского ввода
- Взаимодействие с client для выполнения операций
- Зависимости: client, common_utils, Qt Framework

**Точка входа GUI: gui_main.cpp**
- Создание QApplication
- Инициализация главного окна
- Зависимости: mainwindow, Qt

**Точка входа CLI: client_main.cpp**
- Консольный интерфейс менеджера паролей
- Меню и обработка команд
- Зависимости: client, common_utils

**Общие модули клиента:**
- hashTableUrers.cpp/h — аналогичен серверной версии
- userHashTable.cpp/h — аналогичен серверной версии
- common_utils.cpp/h — аналогичен серверной версии
- register.cpp/h — генерация seed-фраз
- log_in.cpp/h — вспомогательные функции

### 4.7.2 Схема взаимодействия модулей

```
┌─────────────────── КЛИЕНТ ───────────────────┐
│                                               │
│  ┌──────────────┐      ┌──────────────────┐  │
│  │ MainWindow   │◄────►│   Client         │  │
│  │ (Qt GUI)     │      │  (Сетевой слой)  │  │
│  └──────────────┘      └─────────┬────────┘  │
│         │                        │           │
│         │                        │           │
│         ▼                        ▼           │
│  ┌─────────────────────────────────────┐    │
│  │      UserHashTable                  │    │
│  │  (Локальное хранилище паролей)     │    │
│  └─────────────────────────────────────┘    │
│                   │                          │
│                   ▼                          │
│  ┌─────────────────────────────────────┐    │
│  │      common_utils                   │◄───┼─── libsodium
│  │  (Криптография, валидация)          │    │
│  └─────────────────────────────────────┘    │
│                                               │
└───────────────┬───────────────────────────────┘
                │ TCP/IP (JSON)
                │ port 8080
                ▼
┌─────────────────── СЕРВЕР ───────────────────┐
│                                               │
│  ┌──────────────────────────────────────┐    │
│  │         Server                       │    │
│  │    (Обработка TCP-запросов)          │    │
│  └──────┬────────────────────┬──────────┘    │
│         │                    │                │
│         ▼                    ▼                │
│  ┌─────────────┐      ┌─────────────────┐    │
│  │HashTableUsers│      │ UserHashTable   │    │
│  │(Пользователи)│      │(Хранилища)      │    │
│  └──────┬──────┘      └────────┬────────┘    │
│         │                      │              │
│         │ users.json           │ *.vault      │
│         ▼                      ▼              │
│  ┌─────────────────────────────────────┐     │
│  │   Файловая система                  │     │
│  │   - users.json                      │     │
│  │   - server_vaults/[user].vault      │     │
│  └─────────────────────────────────────┘     │
│         ▲                                     │
│         │                                     │
│  ┌──────┴──────────────────────────────┐     │
│  │      common_utils                   │◄────┼─── libsodium
│  │  (Криптография, валидация)          │     │
│  └─────────────────────────────────────┘     │
│         ▲                                     │
│         │                                     │
│  ┌──────┴──────┐    ┌────────────┐           │
│  │  register   │    │  log_in    │           │
│  │(Регистрация)│    │  (Вход)    │           │
│  └─────────────┘    └────────────┘           │
│                                               │
└───────────────────────────────────────────────┘
```

### 4.7.3 Потоки данных между модулями

#### Регистрация пользователя

1. **MainWindow/CLI** → получает данные от пользователя (username, password, codeWord)
2. **MainWindow** → вызывает `client.registerUser(username, password, codeWord, seedWords)`
3. **Client** → формирует JSON-запрос `{"type": "register", "username": "...", "password": "..."}`
4. **Client** → отправляет через TCP на сервер
5. **Server** → принимает запрос в `handleClient()`, маршрутизирует в `handleRegister()`
6. **Server** → вызывает `validateUsername()` и `validatePassword()` из common_utils
7. **Server** → проверяет уникальность через `HashTableUsers.searchLogin()`
8. **Server** → генерирует соль через `generateSaltRaw()`, хеширует пароль через `hashPasswordArgon2id()`
9. **Server** → вызывает `loginExist()` из register для генерации seed-фразы
10. **Server** → сохраняет пользователя в `HashTableUsers.insert()`
11. **Server** → сохраняет в `users.json` через `HashTableUsers.saveToFile()`
12. **Server** → создаёт пустое зашифрованное хранилище через `createUserVault()`
13. **Server** → отправляет JSON-ответ с seed-фразой клиенту
14. **Client** → получает ответ, возвращает seed-фразу
15. **MainWindow** → отображает seed-фразу пользователю

#### Вход в систему

1. **MainWindow** → получает (username, password, codeWord)
2. **Client** → `login(username, password, codeWord)`
3. **Client** → отправляет запрос `{"type": "login", ...}` на сервер
4. **Server** → `handleLogin()` проверяет пользователя в HashTableUsers
5. **Server** → сравнивает хеш пароля (Argon2)
6. **Server** → читает зашифрованное хранилище из `server_vaults/[username].vault`
7. **Server** → отправляет vaultSalt и encrypted_vault клиенту
8. **Client** → деривирует ключ: `deriveVaultKey(codeWord, vaultSalt)` через PBKDF2
9. **Client** → дешифрует хранилище: `decryptAndLoadVault()` через AES-256-GCM
10. **Client** → загружает записи в локальный `UserHashTable`
11. **Client** → устанавливает `isLoggedIn = true`
12. **MainWindow** → переходит в режим работы с паролями

#### Добавление/изменение записи пароля

1. **MainWindow** → пользователь вводит (service, login, password, url, note)
2. **MainWindow** → вызывает `client.addEntry(...)`
3. **Client** → добавляет в локальный `vault->insert(...)`
4. **Client** → вызывает `syncToServer()` для синхронизации
5. **Client** → сериализует хранилище: `vault->toJson()`
6. **Client** → шифрует JSON: `encryptVault()` через AES-256-GCM
7. **Client** → отправляет запрос `{"type": "update_vault", "encrypted_vault": "..."}`
8. **Server** → `handleUpdateVault()` получает зашифрованные данные
9. **Server** → сохраняет в файл: `updateUserVault(username, encryptedData)`
10. **Server** → отправляет подтверждение клиенту
11. **MainWindow** → обновляет отображение списка паролей

### 4.7.4 Зависимости между модулями

**Иерархия зависимостей (от низкого к высокому уровню):**

1. **Уровень 0: Внешние библиотеки**
   - libsodium (криптография)
   - json.hpp (nlohmann/json для JSON)
   - Qt Framework (только для GUI-клиента)

2. **Уровень 1: Базовые утилиты**
   - common_utils (использует libsodium)

3. **Уровень 2: Структуры данных**
   - HashTableUsers (использует common_utils, json)
   - UserHashTable (использует common_utils, json, libsodium)

4. **Уровень 3: Бизнес-логика**
   - register (использует HashTableUsers, common_utils)
   - log_in (использует HashTableUsers, common_utils)

5. **Уровень 4: Основные компоненты**
   - Server (использует все модули уровней 1-3, сетевой слой)
   - Client (использует UserHashTable, common_utils, сетевой слой)

6. **Уровень 5: Интерфейсы пользователя**
   - MainWindow (использует Client, Qt)
   - CLI клиент (использует Client)
   - server_main (использует Server)

### 4.7.5 Механизмы взаимодействия

**Протокол клиент-сервер:**
- Транспорт: TCP sockets
- Формат данных: JSON
- Кодировка: UTF-8
- Структура запроса: `{"type": "operation", "param1": "value1", ...}`
- Структура ответа: `{"status": "success|error", "message": "...", "data": {...}}`

**Синхронизация данных:**
- Клиент хранит локальную копию хранилища паролей
- При изменении автоматически синхронизируется с сервером
- Сервер хранит зашифрованные данные (не может их прочитать без кодового слова)

**Криптографическая безопасность:**
- Пароли пользователей хешируются на сервере (Argon2id)
- Хранилища паролей шифруются на клиенте (AES-256-GCM)
- Ключ шифрования деривируется из кодового слова (PBKDF2)
- Сервер никогда не получает кодовое слово (end-to-end encryption)
